# ===========================================================================
# KD-GAT Pipeline Orchestration
#
# Path layout: {EXPERIMENT_ROOT}/{ds}/{model}_{scale}_{stage}[_{aux}]
# All path logic imported from config/paths.py (single source of truth).
# SLURM config imported from config/constants.py (env-overridable).
#
# All datasets:
#   snakemake -s pipeline/Snakefile --profile profiles/slurm --jobs 20
#
# Single dataset:
#   snakemake -s pipeline/Snakefile --config datasets='["hcrl_sa"]' -n
#
# Dry run:
#   snakemake -s pipeline/Snakefile -n
#
# DAG:
#   snakemake -s pipeline/Snakefile --dag | dot -Tpdf > dag.pdf
# ===========================================================================

from config.paths import (
    get_datasets, EXPERIMENT_ROOT,
    checkpoint_path_str, metrics_path_str, benchmark_path_str, log_path_str,
)
from config.constants import SLURM_ACCOUNT, SLURM_PARTITION, SLURM_GPU_TYPE

ALL_DATASETS = get_datasets()
DATASETS     = config.get("datasets", ALL_DATASETS)
import os as _os, sys as _sys
PY        = _os.environ.get("KD_GAT_PYTHON", _sys.executable)
CLI       = f"{PY} -m pipeline.cli"

# After all rules succeed: populate project DB from filesystem outputs.
onsuccess:
    shell("{PY} -m pipeline.db populate")

include: "rules/common.smk"
include: "rules/targets.smk"
include: "rules/preprocess.smk"
include: "rules/large.smk"
include: "rules/small_kd.smk"
include: "rules/small_nokd.smk"
include: "rules/evaluation.smk"
include: "rules/reports.smk"
include: "rules/utilities.smk"
